# Story 3.4: Order Completion & Handoff

## Status

Draft

## Story

**As a** delivery partner,
**I want** to confirm a successful delivery and complete the handoff,
**so that** the order is marked complete and all parties are notified.

## Acceptance Criteria

1. Delivery partner can mark an order as Delivered with optional proof-of-delivery (photo/signature).
2. Client and restaurant receive notifications upon completion.
3. Client order history is updated with final status and timestamp.
4. Delivery session (including location streaming) is terminated and resources cleaned up.

## Tasks / Subtasks

- [ ] Delivery confirmation (AC: 1)
  - [ ] UI action to mark Delivered; optional PoD capture
  - [ ] Validate order state before allowing completion
- [ ] Notifications (AC: 2)
  - [ ] Emit events to client chat and restaurant dashboard
  - [ ] Include final status and short summary
- [ ] Order history update (AC: 3)
  - [ ] Persist final state, deliveredAt, and PoD metadata (if any)
- [ ] Cleanup (AC: 4)
  - [ ] Stop location stream, unsubscribe clients, release resources

## Dev Notes

- Source reference: `docs/architecture/high-level-architecture.md` (events, subscriptions, lifecycle cleanup)
- Ensure idempotency—duplicate Delivered actions must not duplicate side effects.
- Define `OrderCompletionService` with `complete(orderId, proof?)` and guarantee at-least-once handling.

### Testing

- Happy path: mark delivered → notifications → history updated → streams stopped.
- Edge: double-complete action, missing PoD, network loss during finalize.

## Change Log

| Date | Version | Description | Author |
| :--- | :------ | :---------- | :----- |
| 2025-08-15 | 1.0 | Initial draft of Story 3.4 | PO |

## Dev Agent Record

### Agent Model Used



### Debug Log References



### Completion Notes List

