# Story 2.4: Secure Payment & Order Completion

## Status

Draft

## Story

**As a** client,
**I want** to securely pay for my order and receive confirmation,
**so that** I can complete my purchase with confidence.

## Acceptance Criteria

1. The AI prompts for secure payment within the chat and hands off to a PCI-compliant flow.
2. Payment is processed via a gateway integration; sensitive data never touches our servers directly.
3. On success, the user receives a confirmation message and an order summary/receipt.
4. On failure, the user receives a clear error and a retry option.
5. Order status transitions to Paid and triggers downstream workflows (restaurant + delivery).

## Tasks / Subtasks

- [ ] Payment handoff (AC: 1, 2)
  - [ ] Chat prompts and UX flow to open secure payment sheet/webview
  - [ ] Tokenize payment; never store PAN; use env-configured gateway keys
- [ ] Process payment + update order (AC: 2, 5)
  - [ ] Create PaymentIntent/charge via gateway adapter
  - [ ] Update order to Paid and emit events for restaurant and delivery partner
- [ ] Webhook handling with signature verification
  - [ ] Verify gateway webhook signatures using secret from env
  - [ ] Idempotent processing of webhook events (dedupe by event id)
  - [ ] Reconcile order state on webhook confirmation
- [ ] Confirmation & receipt (AC: 3)
  - [ ] Post-payment confirmation message with order summary
  - [ ] Persist receipt details (txn id, amount, timestamp)
- [ ] Failure handling (AC: 4)
  - [ ] Distinguish decline vs technical error; retry guidance
  - [ ] Log errors without leaking sensitive info

## Dev Notes

- Source reference:
  - `docs/architecture/high-level-architecture.md` (Payments integration, events/queues)
  - `docs/front-end-spec/introduction.md` (tone, reassurance)
- Do not pick a payment provider yet; define `PaymentGatewayAdapter` with createIntent, confirm, and webhook methods.
- Ensure idempotency on serverless handlers to avoid duplicate charges.
- Secrets via environment; no secrets in repo.

### Testing

- Happy path: successful payment → confirmation → order Paid → events emitted.
- Error paths: declined card, network error, idempotency replays.
- Webhook simulation: valid signature accepted; invalid signature rejected with 4xx; idempotency verified.

## Change Log

| Date | Version | Description | Author |
| :--- | :------ | :---------- | :----- |
| 2025-08-15 | 1.0 | Initial draft of Story 2.4 | PO |
| 2025-08-16 | 1.1 | Added webhook signature verification tasks and tests | PO |

## Dev Agent Record

### Agent Model Used



### Debug Log References



### Completion Notes List

