(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const r of document.querySelectorAll('link[rel="modulepreload"]'))a(r);new MutationObserver(r=>{for(const s of r)if(s.type==="childList")for(const i of s.addedNodes)i.tagName==="LINK"&&i.rel==="modulepreload"&&a(i)}).observe(document,{childList:!0,subtree:!0});function n(r){const s={};return r.integrity&&(s.integrity=r.integrity),r.referrerPolicy&&(s.referrerPolicy=r.referrerPolicy),r.crossOrigin==="use-credentials"?s.credentials="include":r.crossOrigin==="anonymous"?s.credentials="omit":s.credentials="same-origin",s}function a(r){if(r.ep)return;r.ep=!0;const s=n(r);fetch(r.href,s)}})();const I=localStorage.getItem("apiBase")||(location.hostname==="localhost"||location.hostname==="127.0.0.1"?"http://localhost:4000":""),P="authToken",_="lastUserEmail",J="lastUserRole",d={installBtn:document.getElementById("installBtn"),chat:document.getElementById("chat"),chatInput:document.getElementById("chatInput"),chatSendBtn:document.getElementById("chatSendBtn"),email:document.getElementById("email"),password:document.getElementById("password"),role:document.getElementById("role"),registerBtn:document.getElementById("registerBtn"),loginBtn:document.getElementById("loginBtn"),logoutBtn:document.getElementById("logoutBtn"),log:document.getElementById("log"),apiBase:document.getElementById("apiBase"),roleBadge:document.getElementById("roleBadge"),loadRestaurantsBtn:document.getElementById("loadRestaurantsBtn"),restaurantsList:document.getElementById("restaurantsList"),menuHeader:document.getElementById("menuHeader"),menuList:document.getElementById("menuList"),cartList:document.getElementById("cartList"),cartTotal:document.getElementById("cartTotal"),clearCartBtn:document.getElementById("clearCartBtn"),reviewOrderBtn:document.getElementById("reviewOrderBtn"),placeOrderBtn:document.getElementById("placeOrderBtn"),refreshOrdersBtn:document.getElementById("refreshOrdersBtn"),ordersList:document.getElementById("ordersList"),trackingOrder:document.getElementById("trackingOrder"),trackingStatus:document.getElementById("trackingStatus"),trackingCoords:document.getElementById("trackingCoords"),stopTrackingBtn:document.getElementById("stopTrackingBtn")};async function It(e){try{const t=await l("/payments/intent",{method:"POST",body:{orderId:e}});if(!t.ok)return o(`Payment intent failed: ${t.status} ${t.data.error||""}`);const{clientSecret:n,amountCents:a}=t.data;o(`Payment intent created for order #${e}: ${$(a)}`);const r=await l("/payments/confirm",{method:"POST",body:{orderId:e,clientSecret:n,outcome:"succeeded"}});if(!r.ok)return o(`Payment confirm failed: ${r.status} ${r.data.error||""}`);o(`Payment ${r.data.paymentStatus} for order #${e}`),await U()}catch(t){E(`payment error: ${t.message}`)}}d.apiBase.textContent=I;M();let O;window.addEventListener("beforeinstallprompt",e=>{e.preventDefault(),O=e,d.installBtn.hidden=!1});d.installBtn.addEventListener("click",async()=>{O&&(O.prompt(),await O.userChoice,O=null,d.installBtn.hidden=!0)});function E(e){d.log.textContent+=`
${e}`}function o(e){const t=document.createElement("p");t.textContent=e,d.chat.appendChild(t)}let h=null,p=[],mt=[],g=(localStorage.getItem(J)||"").toLowerCase();function y(){return g==="staff"||g==="admin"}function M(){try{const e=document.getElementById("adminSection");if(e){const c=g==="admin";e.style.display=c?"":"none",c?(K().catch(()=>{}),Ct()):(V(),F=0,z())}const t=document.getElementById("deliverySection");if(t){const c=g==="delivery";t.style.display=c?"":"none",c?(x().catch(()=>{}),vt()):(Z(),q(),N=0,Y())}const n=document.getElementById("rcRestaurant"),a=document.getElementById("rcLoadOrdersBtn"),r=document.getElementById("rcHint"),s=d.roleBadge,i=g||"guest";s&&(s.textContent=`role: ${i}`),a&&(a.disabled=!y(),a.title=y()?"":"Restaurant Console is available to staff or admin only."),n&&(n.disabled=!y(),n.title=y()?"":"Login as staff or admin to select a restaurant."),m.statusFilter&&(m.statusFilter.disabled=!y(),m.statusFilter.title=y()?"":"Login as staff or admin to filter orders."),m.autoRefresh&&(m.autoRefresh.disabled=!y(),m.autoRefresh.title=y()?"":"Login as staff or admin to enable auto-refresh.",y()||(m.autoRefresh.checked=!1,H())),r&&(r.style.display=y()?"none":"")}catch{}}function $(e){return((e||0)/100).toLocaleString(void 0,{style:"currency",currency:"USD"})}function T(e,t){const n=document.createElement("span");return n.className=`badge ${t||""}`.trim(),n.textContent=e,n}async function l(e,{method:t="GET",body:n}={}){if(!I)throw new Error("API base not configured");const a={"Content-Type":"application/json"},r=localStorage.getItem(P);r&&(a.Authorization=`Bearer ${r}`);const s=await fetch(`${I}${e}`,{method:t,headers:a,body:n?JSON.stringify(n):void 0}),i=await s.json().catch(()=>({}));return{ok:s.ok,status:s.status,data:i}}async function ft(){try{const e=await l("/restaurants");if(!e.ok)return o(`Could not load restaurants (${e.status})`);kt(e.data.restaurants)}catch(e){E(`restaurants error: ${e.message}`)}}function kt(e=[]){d.restaurantsList.innerHTML="",e.forEach(t=>{const n=document.createElement("li"),a=document.createElement("button");a.textContent=`${t.name} — ${t.address}`,a.addEventListener("click",()=>pt(t)),n.appendChild(a),d.restaurantsList.appendChild(n)})}async function pt(e){h=e,d.menuHeader.textContent=`Menu — ${e.name}`,d.menuList.innerHTML="";try{const t=await l(`/restaurants/${e.id}/menu`);if(!t.ok)return o(`Could not load menu (${t.status})`);wt(t.data.items||[])}catch(t){E(`menu error: ${t.message}`)}}function wt(e=[]){d.menuList.innerHTML="",mt=e,e.forEach(t=>{const n=document.createElement("li"),a=document.createElement("button");a.textContent="Add",a.addEventListener("click",()=>yt(t)),n.textContent=`${t.name} — ${$(t.priceCents)} `,n.appendChild(a),d.menuList.appendChild(n)})}function yt(e){if(!h)return o("Select a restaurant first");const t=`${h.id}:${e.id}`,n=p.find(a=>`${a.restaurantId}:${a.itemId}`===t);n?n.qty+=1:p.push({restaurantId:h.id,itemId:e.id,name:e.name,priceCents:e.priceCents,qty:1}),k()}function k(){d.cartList.innerHTML="";let e=0;p.forEach(t=>{const n=document.createElement("li"),a=t.priceCents*t.qty;e+=a;const r=document.createElement("button");r.textContent="-",r.addEventListener("click",()=>{t.qty-=1,t.qty<=0&&(p=p.filter(i=>i!==t)),k()});const s=document.createElement("button");s.textContent="+",s.addEventListener("click",()=>{t.qty+=1,k()}),n.textContent=`${t.name} x${t.qty} — ${$(a)} `,n.appendChild(r),n.appendChild(s),d.cartList.appendChild(n)}),d.cartTotal.textContent=$(e),bt()}function gt(){if(!h)return"No restaurant selected.";if(!p.length)return"Cart is empty.";const e=p.map(s=>`• ${s.name} x${s.qty} = ${$(s.priceCents*s.qty)}`),t=p.reduce((s,i)=>s+i.priceCents*i.qty,0),n=Math.round(t*.08),a=Math.round(t*.03),r=t+n+a;return`Order @ ${h.name}
${e.join(`
`)}
Subtotal: ${$(t)}
Taxes: ${$(n)}
Fees: ${$(a)}
Total: ${$(r)}`}async function ht(){if(!h)return o("Please select a restaurant before placing an order.");if(!p.length)return o("Add items to the cart first.");const e=p.map(t=>({itemId:t.itemId,name:t.name,priceCents:t.priceCents,qty:t.qty}));try{d.placeOrderBtn.disabled=!0;const t=await l("/orders",{method:"POST",body:{restaurantId:h.id,items:e}});t.ok?(o(`Order placed! ID: ${t.data.order.id}, status: ${t.data.order.status}`),p=[],k(),await U()):o(`Failed to place order: ${t.status} ${t.data.error||""}`)}finally{d.placeOrderBtn.disabled=!1}}function St(){return`cart:${localStorage.getItem(_)||"guest"}`}function bt(){try{const e=St(),t={restaurant:h?{id:h.id,name:h.name}:null,cart:p};localStorage.setItem(e,JSON.stringify(t))}catch{}}async function U(){const e=await l("/orders");if(!e.ok)return o(`Failed to load orders: ${e.status}`);xt(e.data.orders||[])}function xt(e=[]){d.ordersList.innerHTML="",e.forEach(t=>{const n=document.createElement("li"),a=document.createElement("div");a.textContent=`#${t.id} — R${t.restaurantId}`;const r=T(t.status,`status status-${t.status}`);r.style.marginLeft="8px",a.appendChild(r),n.appendChild(a);const s=document.createElement("div");s.className="muted",s.textContent=(t.items||[]).map(f=>`${f.name} x${f.qty}`).join(", "),n.appendChild(s);const i=T(t.paymentStatus||"Unpaid",`status pay-${t.paymentStatus||"Unpaid"}`);n.appendChild(i);const c=Et(t.status);if(c&&y()){const f=document.createElement("button");f.textContent=`Advance → ${c}`,f.addEventListener("click",async()=>{f.disabled=!0;try{await $t(t.id,c)}finally{f.disabled=!1}}),n.appendChild(f)}if(!t.paymentStatus||t.paymentStatus==="Unpaid"||t.paymentStatus==="Failed"){const f=document.createElement("button");f.textContent="Pay",f.addEventListener("click",()=>It(t.id)),n.appendChild(f)}const u=document.createElement("button");u.textContent="Track",u.addEventListener("click",()=>Tt(t.id)),n.appendChild(u),d.ordersList.appendChild(n)})}function Et(e){switch(e){case"Submitted":return"Accepted";case"Accepted":return"Preparing";case"Preparing":return"ReadyForPickup";default:return null}}async function $t(e,t){const n=await l(`/orders/${e}/status`,{method:"POST",body:{next:t}});n.ok?await U():n.status===409?o(`Invalid transition: ${n.data.error}`):n.status===401?o("Please login to perform this action."):n.status===403?o("Forbidden: staff or admin role required to advance orders."):o(`Failed to update: ${n.status}`)}let S=null,C=null,b=null;function Tt(e){if(j(),!I)return o("API base not configured");d.trackingOrder.textContent=`#${e}`,d.trackingStatus.textContent="Connecting...",d.trackingCoords.textContent="",Ot();const t=`${I}/tracking/${e}/stream`;S=new EventSource(t),S.onmessage=n=>{try{const a=JSON.parse(n.data);a.type==="hello"?d.trackingStatus.textContent=`Status: ${a.status}`:a.type==="location"?(d.trackingCoords.textContent=`Lat ${a.lat.toFixed(6)}, Lng ${a.lng.toFixed(6)} @ ${new Date(a.ts).toLocaleTimeString()}`,Pt(a.lat,a.lng)):a.type==="complete"&&(d.trackingStatus.textContent="Arrived (simulation complete)",j())}catch{}},S.onerror=()=>{d.trackingStatus.textContent="Connection error"}}function j(){S&&(S.close(),S=null),d.trackingStatus.textContent="Not tracking.",d.trackingOrder.textContent="—",d.trackingCoords.textContent="",Rt()}function Ot(){if(typeof L>"u")return;const e=document.getElementById("map");e&&(C||(C=L.map(e).setView([18.936,-99.223],14),L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{maxZoom:19,attribution:"&copy; OpenStreetMap contributors"}).addTo(C)))}function Pt(e,t){if(!C)return;const n=[e,t];b?b.setLatLng(n):b=L.marker(n).addTo(C),C.setView(n,C.getZoom()||14)}function Rt(){b&&(C.removeLayer(b),b=null)}async function K(){if(g==="admin")try{const[e,t,n,a,r]=await Promise.all([l("/admin/metrics"),l("/admin/users"),l("/admin/restaurants"),l("/admin/orders"),Ft()]);e.ok&&At(e.data.metrics),t.ok&&_t(t.data.users||[]),n.ok&&Mt(n.data.restaurants||[]),a.ok&&Ut(a.data.orders||[])}catch(e){E(`admin load error: ${e.message}`)}}function At(e={}){const{usersTotal:t=0,restaurantsTotal:n=0,ordersTotal:a=0,revenueCents:r=0}=e,s=document.getElementById("admUsers"),i=document.getElementById("admRestaurants"),c=document.getElementById("admOrders"),u=document.getElementById("admRevenue");s&&(s.textContent=String(t)),i&&(i.textContent=String(n)),c&&(c.textContent=String(a)),u&&(u.textContent=$(Number(r)||0))}function _t(e=[]){const t=document.getElementById("admUsersList");t&&(t.innerHTML="",e.forEach(n=>{const a=document.createElement("li");a.textContent=`#${n.id} — ${n.email} (${n.role})`,t.appendChild(a)}))}function Mt(e=[]){const t=document.getElementById("admRestaurantsList");t&&(t.innerHTML="",e.forEach(n=>{const a=document.createElement("li");a.textContent=`#${n.id} — ${n.name}`,t.appendChild(a)}))}function Ut(e=[]){const t=document.getElementById("admOrdersList");t&&(t.innerHTML="",e.forEach(n=>{const a=document.createElement("li"),r=T(n.status,`status status-${n.status}`),s=T(n.paymentStatus||"Unpaid",`status pay-${n.paymentStatus||"Unpaid"}`);a.textContent=`#${n.id} — R${n.restaurantId} `,a.appendChild(r),a.appendChild(s);const i=document.createElement("div");i.className="row";const c=document.createElement("select");(window.__adminPartners||[]).forEach(w=>{const W=document.createElement("option");W.value=w.id,W.textContent=w.name?`#${w.id} — ${w.name}`:`#${w.id}`,c.appendChild(W)});const f=document.createElement("button");f.textContent="Assign",f.title="Assign this order to the selected delivery partner",f.addEventListener("click",async()=>{if(!c.value){o("Select a partner first");return}f.disabled=!0;try{await Nt(n.id,Number(c.value))&&o(`Assigned order #${n.id} to partner #${c.value}`)}finally{f.disabled=!1}}),i.appendChild(c),i.appendChild(f),a.appendChild(i),t.appendChild(a)}))}async function Ft(){try{const e=await l("/admin/delivery-partners");return e.ok?window.__adminPartners=e.data.partners||[]:window.__adminPartners=[],window.__adminPartners}catch{return window.__adminPartners=[],[]}}async function Nt(e,t){try{const n=await l("/admin/assignments",{method:"POST",body:{orderId:e,partnerId:t}});return n.ok?!0:(o(`Failed to assign: ${n.status}`),!1)}catch(n){return E(`assign error: ${n.message}`),!1}}let v=null,F=0;function qt(e){o(`[ADMIN] ${e}`)}function z(){if(!document.getElementById("admUsers"))return;const t=document.getElementById("admBell");t&&(t.textContent=String(F))}function Ct(){try{V()}catch{}if(g!=="admin")return;const e=localStorage.getItem(P);if(!e)return;const t=`${I}/admin/events?token=${encodeURIComponent(e)}`;v=new EventSource(t),v.onmessage=n=>{try{const a=JSON.parse(n.data);F+=1,z();const r=a.message||a.type;qt(r);const s=document.getElementById("admNotifications");if(s){const i=document.createElement("li");i.textContent=`${new Date(a.ts||Date.now()).toLocaleTimeString()} — ${a.type}: ${r}`,s.prepend(i)}}catch{}},v.addEventListener("ping",()=>{}),v.onerror=()=>{setTimeout(()=>{Ct()},3e3)}}function V(){if(v){try{v.close()}catch{}v=null}}let B=null,N=0,R=null;async function x(){try{const e=await l("/delivery/assignments");if(!e.ok)return o(`Failed to load assignments: ${e.status}`);Dt(e.data.assignments||[])}catch(e){E(`delivery load error: ${e.message}`)}}function Dt(e=[]){const t=document.getElementById("delAssignments");t&&(t.innerHTML="",e.forEach(n=>{const a=document.createElement("li"),r=document.createElement("div");r.textContent=`Assignment #${n.id} — Order #${n.orderId} — ${n.status}`,a.appendChild(r);const s=document.createElement("div");s.className="row";const i=document.createElement("button");i.textContent="Accept",i.disabled=n.status!=="Assigned",i.addEventListener("click",async()=>{i.disabled=!0;try{await Ht(n.id),await x()}finally{i.disabled=!1}});const c=document.createElement("button");c.textContent="Picked Up",c.disabled=n.status!=="Accepted",c.addEventListener("click",async()=>{c.disabled=!0;try{await G(n.id,"PickedUp"),await x()}finally{c.disabled=!1}});const u=document.createElement("button");u.textContent="Delivered",u.disabled=n.status!=="PickedUp",u.addEventListener("click",async()=>{u.disabled=!0;try{await G(n.id,"Delivered"),await x()}finally{u.disabled=!1}}),s.appendChild(i),s.appendChild(c),s.appendChild(u),a.appendChild(s),t.appendChild(a)}))}async function Ht(e){const t=await l(`/delivery/assignments/${encodeURIComponent(e)}/accept`,{method:"POST"});t.ok||o(`Failed to accept: ${t.status}`)}async function G(e,t){const n=await l(`/delivery/assignments/${encodeURIComponent(e)}/status`,{method:"POST",body:{status:t}});n.ok||o(`Failed to set status: ${n.status}`)}function Y(){const e=document.getElementById("delBell");e&&(e.textContent=String(N))}function vt(){if(Z(),g!=="delivery")return;const e=localStorage.getItem(P);if(!e)return;const t=`${I}/delivery/events?token=${encodeURIComponent(e)}`;B=new EventSource(t),B.onmessage=n=>{try{const a=JSON.parse(n.data);N+=1,Y();const r=a.message||a.type;o(`[DELIVERY] ${r}`);const s=document.getElementById("delNotifications");if(s){const i=document.createElement("li");i.textContent=`${new Date(a.ts||Date.now()).toLocaleTimeString()} — ${a.type}: ${r}`,s.prepend(i)}a.type==="assignment_created"&&x().catch(()=>{})}catch{}},B.addEventListener("ping",()=>{}),B.onerror=()=>{setTimeout(()=>vt(),3e3)}}function Z(){if(B){try{B.close()}catch{}B=null}}function q(){R&&(clearInterval(R),R=null)}function Wt(){if(q(),g!=="delivery")return;const e=document.getElementById("delShareLocation");if(!(e!=null&&e.checked))return;const t=async n=>{try{const a=Number((n==null?void 0:n.latitude)??18.936),r=Number((n==null?void 0:n.longitude)??-99.223);await l("/delivery/location",{method:"POST",body:{lat:a,lng:r}})}catch{}};navigator.geolocation?navigator.geolocation.getCurrentPosition(n=>t(n.coords),()=>t(null),{enableHighAccuracy:!0,maximumAge:1e4}):t(null),R=setInterval(()=>{navigator.geolocation?navigator.geolocation.getCurrentPosition(n=>t(n.coords),()=>t(null),{enableHighAccuracy:!0,maximumAge:1e4}):t(null)},1e4)}var Q;(Q=d.loadRestaurantsBtn)==null||Q.addEventListener("click",ft);var X;(X=d.clearCartBtn)==null||X.addEventListener("click",()=>{p=[],k()});var tt;(tt=d.reviewOrderBtn)==null||tt.addEventListener("click",()=>o(gt()));var et;(et=d.placeOrderBtn)==null||et.addEventListener("click",ht);var nt;(nt=d.refreshOrdersBtn)==null||nt.addEventListener("click",U);var at;(at=d.stopTrackingBtn)==null||at.addEventListener("click",j);var rt;(rt=d.chatSendBtn)==null||rt.addEventListener("click",Bt);var st;(st=d.chatInput)==null||st.addEventListener("keydown",e=>{e.key==="Enter"&&Bt()});var ot;(ot=document.getElementById("admRefreshBtn"))==null||ot.addEventListener("click",()=>{K().catch(()=>{})});var it;(it=document.getElementById("delRefreshBtn"))==null||it.addEventListener("click",()=>{x().catch(()=>{})});var dt;(dt=document.getElementById("delShareLocation"))==null||dt.addEventListener("change",()=>{document.getElementById("delShareLocation").checked?Wt():q()});function Bt(){var t;const e=(((t=d.chatInput)==null?void 0:t.value)||"").trim();e&&(d.chatInput.value="",o(`You: ${e}`),jt(e))}async function jt(e){const t=e.toLowerCase();if(t.startsWith("show restaurants")||t==="restaurants"||t==="show menus"||t==="show menu"){await ft(),o('Loaded restaurants. Tap one above or type "menu <name>"');return}if(t.startsWith("menu ")){const n=t.replace(/^menu\s+/,"").trim(),a=await l("/restaurants");if(a.ok){const r=(a.data.restaurants||[]).find(s=>s.name.toLowerCase().includes(n));r?(await pt(r),o(`Showing menu for ${r.name}`)):o(`Could not find restaurant matching "${n}"`)}else o("Failed to load restaurants");return}if(t.startsWith("add ")){const n=t.match(/^add\s+(\d+)\s+(.+)$/)||t.match(/^add\s+(.+)$/);let a=1,r="";if(n){n.length===3?(a=parseInt(n[1],10)||1,r=n[2]):r=n[1];const s=(mt||[]).find(i=>i.name.toLowerCase().includes(r));if(!s)return o(`Item not found: ${r}`);for(let i=0;i<a;i++)yt(s);o(`Added ${a} x ${s.name}`)}else o("Try: add 2 tacos");return}if(t.startsWith("remove ")||t.startsWith("delete ")){const n=t.match(/^(?:remove|delete)\s+(\d+)\s+(.+)$/)||t.match(/^(?:remove|delete)\s+(.+)$/);let a=1,r="";if(n){n.length===3?(a=parseInt(n[1],10)||1,r=n[2]):r=n[1];const s=p.findIndex(i=>i.name.toLowerCase().includes(r));if(s===-1)return o(`Item not in cart: ${r}`);p[s].qty-=a,p[s].qty<=0&&p.splice(s,1),k(),o(`Removed ${a} x ${r}`)}else o("Try: remove 1 tacos");return}if(t==="clear cart"){p=[],k(),o("Cart cleared");return}if(t==="summary"||t==="review"){o(gt());return}if(t==="place order"||t==="order"){await ht();return}o("I didn't understand. Try: 'show restaurants', 'menu <name>', 'add 2 tacos', 'summary', 'place order'.")}const m={restaurant:document.getElementById("rcRestaurant"),loadBtn:document.getElementById("rcLoadOrdersBtn"),statusFilter:document.getElementById("rcStatusFilter"),autoRefresh:document.getElementById("rcAutoRefresh"),list:document.getElementById("rcOrdersList")};async function Jt(){try{const e=await l("/restaurants");if(!e.ok)return;m.restaurant.innerHTML="",(e.data.restaurants||[]).forEach(t=>{const n=document.createElement("option");n.value=t.id,n.textContent=`${t.name}`,m.restaurant.appendChild(n)}),M()}catch{}}async function D(){var t;const e=m.restaurant.value;if(!y())return o("Restaurant Console is available to staff or admin only. Please login as staff/admin.");if(!e)return o("Please select a restaurant to load orders.");try{m.loadBtn.disabled=!0;const n=await l(`/orders?restaurantId=${encodeURIComponent(e)}`);if(!n.ok)return o(`Failed to load orders for restaurant ${e}: ${n.status}`);const a=n.data.orders||[],r=((t=m.statusFilter)==null?void 0:t.value)||"all",s=r==="all"?a:a.filter(i=>i.status===r);Kt(s)}finally{m.loadBtn.disabled=!y()}}let A=null;function H(){A&&(clearInterval(A),A=null)}function Lt(){var e;H(),y()&&(e=m.autoRefresh)!=null&&e.checked&&(A=setInterval(()=>{D().catch(()=>{})},5e3))}function Kt(e=[]){m.list.innerHTML="",e.forEach(t=>{const n=document.createElement("li"),a=document.createElement("div");a.textContent=`#${t.id}`;const r=T(t.status,`status status-${t.status}`);r.style.marginLeft="8px";const s=T(t.paymentStatus||"Unpaid",`status pay-${t.paymentStatus||"Unpaid"}`);s.style.marginLeft="6px",a.appendChild(r),a.appendChild(s),n.appendChild(a);const i=document.createElement("div");i.className="muted",i.textContent=(t.items||[]).map(u=>`${u.name} x${u.qty}`).join(", "),n.appendChild(i);const c=Et(t.status);if(c){const u=document.createElement("button");u.textContent=`Advance → ${c}`,u.addEventListener("click",async()=>{u.disabled=!0;try{await $t(t.id,c),await D()}finally{u.disabled=!1}}),n.appendChild(u)}m.list.appendChild(n)})}var ct;(ct=m.loadBtn)==null||ct.addEventListener("click",D);Jt();var lt;(lt=m.statusFilter)==null||lt.addEventListener("change",()=>{y()&&D()});var ut;(ut=m.autoRefresh)==null||ut.addEventListener("change",()=>{m.autoRefresh.checked?Lt():H()});d.registerBtn.addEventListener("click",async()=>{var e;try{const t=d.email.value.trim(),n=d.password.value,a=((e=d.role)==null?void 0:e.value)||"client";if(!t||!/^[^@\s]+@[^@\s]+\.[^@\s]+$/.test(t))return o("Please enter a valid email.");if(!n||n.length<6)return o("Password must be at least 6 characters.");if(!["client","staff","admin"].includes(a))return o("Invalid role selected.");const r=await l("/auth/register",{method:"POST",body:{email:t,password:n,role:a}});if(r.ok){const s=r.data.email||t;try{localStorage.setItem(_,s)}catch{}o(`Registered ${s}`)}else o(`Register failed: ${r.status} ${r.data.error||""}`)}catch(t){E(`register error: ${t.message}`)}});d.loginBtn.addEventListener("click",async()=>{try{const e=d.email.value.trim(),t=d.password.value;if(!e)return o("Please enter your email.");if(!t)return o("Please enter your password.");const n=await l("/auth/login",{method:"POST",body:{email:e,password:t}});if(n.ok&&n.data.token){localStorage.setItem(P,n.data.token),o("Logged in");const a=await l("/me");if(a.ok){try{localStorage.setItem(_,a.data.user.email||"")}catch{}try{g=(a.data.user.role||"").toLowerCase(),localStorage.setItem(J,g)}catch{}o(`Hello ${a.data.user.email} (role: ${a.data.user.role})`),M(),Lt(),g==="admin"&&await K()}}else o(`Login failed: ${n.status} ${n.data.error||""}`)}catch(e){E(`login error: ${e.message}`)}});d.logoutBtn.addEventListener("click",async()=>{try{const e=await l("/auth/logout",{method:"POST"});if(e.ok){localStorage.removeItem(P);try{localStorage.removeItem(J),g="",M()}catch{}H(),V(),F=0,z(),Z(),q(),N=0,Y(),o("Logged out")}else o(`Logout failed: ${e.status} ${e.data.error||""}`)}catch(e){E(`logout error: ${e.message}`)}});try{if(!localStorage.getItem("onboarded"))o("Welcome to Marshanta!"),o("How to order: 1) Load restaurants, 2) Pick a restaurant and add items, 3) Place order, 4) Pay and track delivery."),o("Create an account or login to continue."),localStorage.setItem("onboarded","1");else{const t=localStorage.getItem(_);o(t?`Welcome back, ${t}!`:"Welcome back!")}}catch{o("Welcome to Marshanta!")}"serviceWorker"in navigator&&navigator.serviceWorker.register("/service-worker.js").then(()=>E("SW registered")).catch(e=>E(`SW error: ${e.message}`));
