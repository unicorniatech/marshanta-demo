(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const r of document.querySelectorAll('link[rel="modulepreload"]'))a(r);new MutationObserver(r=>{for(const s of r)if(s.type==="childList")for(const d of s.addedNodes)d.tagName==="LINK"&&d.rel==="modulepreload"&&a(d)}).observe(document,{childList:!0,subtree:!0});function n(r){const s={};return r.integrity&&(s.integrity=r.integrity),r.referrerPolicy&&(s.referrerPolicy=r.referrerPolicy),r.crossOrigin==="use-credentials"?s.credentials="include":r.crossOrigin==="anonymous"?s.credentials="omit":s.credentials="same-origin",s}function a(r){if(r.ep)return;r.ep=!0;const s=n(r);fetch(r.href,s)}})();const k=localStorage.getItem("apiBase")||(location.hostname==="localhost"||location.hostname==="127.0.0.1"?"http://localhost:4000":""),N="authToken",M="lastUserEmail",Y="lastUserRole",i={installBtn:document.getElementById("installBtn"),chat:document.getElementById("chat"),chatInput:document.getElementById("chatInput"),chatSendBtn:document.getElementById("chatSendBtn"),navClient:document.getElementById("navClient"),navDelivery:document.getElementById("navDelivery"),navRestaurant:document.getElementById("navRestaurant"),navAdmin:document.getElementById("navAdmin"),email:document.getElementById("email"),password:document.getElementById("password"),role:document.getElementById("role"),registerBtn:document.getElementById("registerBtn"),loginBtn:document.getElementById("loginBtn"),logoutBtn:document.getElementById("logoutBtn"),log:document.getElementById("log"),apiBase:document.getElementById("apiBase"),roleBadge:document.getElementById("roleBadge"),clientSection:document.getElementById("clientSection"),loadRestaurantsBtn:document.getElementById("loadRestaurantsBtn"),restaurantsList:document.getElementById("restaurantsList"),menuHeader:document.getElementById("menuHeader"),menuList:document.getElementById("menuList"),cartList:document.getElementById("cartList"),cartTotal:document.getElementById("cartTotal"),clearCartBtn:document.getElementById("clearCartBtn"),reviewOrderBtn:document.getElementById("reviewOrderBtn"),placeOrderBtn:document.getElementById("placeOrderBtn"),refreshOrdersBtn:document.getElementById("refreshOrdersBtn"),ordersList:document.getElementById("ordersList"),trackingOrder:document.getElementById("trackingOrder"),trackingStatus:document.getElementById("trackingStatus"),trackingCoords:document.getElementById("trackingCoords"),stopTrackingBtn:document.getElementById("stopTrackingBtn"),admCreatePartnerBtn:document.getElementById("admCreatePartnerBtn"),admNewPartnerEmail:document.getElementById("admNewPartnerEmail"),admNewPartnerName:document.getElementById("admNewPartnerName"),admNewPartnerPhone:document.getElementById("admNewPartnerPhone"),admNewPartnerVehicle:document.getElementById("admNewPartnerVehicle")};async function Re(t){try{const e=await m("/payments/intent",{method:"POST",body:{orderId:t}});if(!e.ok)return o(`Payment intent failed: ${e.status} ${e.data.error||""}`);const{clientSecret:n,amountCents:a}=e.data;o(`Payment intent created for order #${t}: ${C(a)}`);const r=await m("/payments/confirm",{method:"POST",body:{orderId:t,clientSecret:n,outcome:"succeeded"}});if(!r.ok)return o(`Payment confirm failed: ${r.status} ${r.data.error||""}`);o(`Payment ${r.data.paymentStatus} for order #${t}`),await H()}catch(e){E(`payment error: ${e.message}`)}}i.apiBase.textContent=k;q();let A;window.addEventListener("beforeinstallprompt",t=>{t.preventDefault(),A=t,i.installBtn.hidden=!1});i.installBtn.addEventListener("click",async()=>{A&&(A.prompt(),await A.userChoice,A=null,i.installBtn.hidden=!0)});function E(t){i.log.textContent+=`
${t}`}function o(t){const e=document.createElement("p");e.textContent=t,i.chat.appendChild(e)}function D(t){if(t){t.scrollIntoView({behavior:"smooth",block:"start"});try{const e=t.style.outline;t.style.outline="2px solid #0ea5e9",setTimeout(()=>{t.style.outline=e||""},800)}catch{}}}function h(t,e){t&&(t.style.display=e?"":"none")}let v=null,y=[],Ce=[],g=(localStorage.getItem(Y)||"").toLowerCase();function p(){return g==="staff"||g==="admin"}function q(){try{const t=document.getElementById("adminSection");if(t){const u=g==="admin";t.style.display=u?"":"none",u?(_().catch(()=>{}),Pe()):(G(),W=0,Z())}const e=document.getElementById("deliverySection");if(e){const u=g==="delivery";e.style.display=u?"":"none",u?(T().catch(()=>{}),xe()):(X(),j(),V=0,Q())}const n=i.clientSection;if(n){const u=g==="client"||p()||!g;h(n,u)}const a=document.getElementById("rcSection");a&&h(a,p());const r=document.getElementById("rcRestaurant"),s=document.getElementById("rcLoadOrdersBtn"),d=document.getElementById("rcHint"),c=i.roleBadge,l=g||"guest";c&&(c.textContent=`role: ${l}`),s&&(s.disabled=!p(),s.title=p()?"":"Restaurant Console is available to staff or admin only."),r&&(r.disabled=!p(),r.title=p()?"":"Login as staff or admin to select a restaurant."),f.statusFilter&&(f.statusFilter.disabled=!p(),f.statusFilter.title=p()?"":"Login as staff or admin to filter orders."),f.autoRefresh&&(f.autoRefresh.disabled=!p(),f.autoRefresh.title=p()?"":"Login as staff or admin to enable auto-refresh.",p()||(f.autoRefresh.checked=!1,K())),d&&(d.style.display=p()?"none":"")}catch{}}function C(t){return((t||0)/100).toLocaleString(void 0,{style:"currency",currency:"USD"})}function O(t,e){const n=document.createElement("span");return n.className=`badge ${e||""}`.trim(),n.textContent=t,n}async function m(t,{method:e="GET",body:n}={}){if(!k)throw new Error("API base not configured");const a={"Content-Type":"application/json"},r=localStorage.getItem(N);r&&(a.Authorization=`Bearer ${r}`);const s=await fetch(`${k}${t}`,{method:e,headers:a,body:n?JSON.stringify(n):void 0}),d=await s.json().catch(()=>({}));return{ok:s.ok,status:s.status,data:d}}async function $e(){try{const t=await m("/restaurants");if(!t.ok)return o(`Could not load restaurants (${t.status})`);Ae(t.data.restaurants)}catch(t){E(`restaurants error: ${t.message}`)}}function Ae(t=[]){i.restaurantsList.innerHTML="",t.forEach(e=>{const n=document.createElement("li"),a=document.createElement("button");a.textContent=`${e.name} — ${e.address}`,a.addEventListener("click",()=>Be(e)),n.appendChild(a),i.restaurantsList.appendChild(n)})}async function Be(t){v=t,i.menuHeader.textContent=`Menu — ${t.name}`,i.menuList.innerHTML="";try{const e=await m(`/restaurants/${t.id}/menu`);if(!e.ok)return o(`Could not load menu (${e.status})`);Ne(e.data.items||[])}catch(e){E(`menu error: ${e.message}`)}}function Ne(t=[]){i.menuList.innerHTML="",Ce=t,t.forEach(e=>{const n=document.createElement("li"),a=document.createElement("button");a.textContent="Add",a.addEventListener("click",()=>Ie(e)),n.textContent=`${e.name} — ${C(e.priceCents)} `,n.appendChild(a),i.menuList.appendChild(n)})}function Ie(t){if(!v)return o("Select a restaurant first");const e=`${v.id}:${t.id}`,n=y.find(a=>`${a.restaurantId}:${a.itemId}`===e);n?n.qty+=1:y.push({restaurantId:v.id,itemId:t.id,name:t.name,priceCents:t.priceCents,qty:1}),b()}function b(){i.cartList.innerHTML="";let t=0;y.forEach(e=>{const n=document.createElement("li"),a=e.priceCents*e.qty;t+=a;const r=document.createElement("button");r.textContent="-",r.addEventListener("click",()=>{e.qty-=1,e.qty<=0&&(y=y.filter(d=>d!==e)),b()});const s=document.createElement("button");s.textContent="+",s.addEventListener("click",()=>{e.qty+=1,b()}),n.textContent=`${e.name} x${e.qty} — ${C(a)} `,n.appendChild(r),n.appendChild(s),i.cartList.appendChild(n)}),i.cartTotal.textContent=C(t),Ue()}function we(){if(!v)return"No restaurant selected.";if(!y.length)return"Cart is empty.";const t=y.map(s=>`• ${s.name} x${s.qty} = ${C(s.priceCents*s.qty)}`),e=y.reduce((s,d)=>s+d.priceCents*d.qty,0),n=Math.round(e*.08),a=Math.round(e*.03),r=e+n+a;return`Order @ ${v.name}
${t.join(`
`)}
Subtotal: ${C(e)}
Taxes: ${C(n)}
Fees: ${C(a)}
Total: ${C(r)}`}async function Le(){if(!v)return o("Please select a restaurant before placing an order.");if(!y.length)return o("Add items to the cart first.");const t=y.map(e=>({itemId:e.itemId,name:e.name,priceCents:e.priceCents,qty:e.qty}));try{i.placeOrderBtn.disabled=!0;const e=await m("/orders",{method:"POST",body:{restaurantId:v.id,items:t}});e.ok?(o(`Order placed! ID: ${e.data.order.id}, status: ${e.data.order.status}`),y=[],b(),await H()):o(`Failed to place order: ${e.status} ${e.data.error||""}`)}finally{i.placeOrderBtn.disabled=!1}}function _e(){return`cart:${localStorage.getItem(M)||"guest"}`}function Ue(){try{const t=_e(),e={restaurant:v?{id:v.id,name:v.name}:null,cart:y};localStorage.setItem(t,JSON.stringify(e))}catch{}}async function H(){const t=await m("/orders");if(!t.ok)return o(`Failed to load orders: ${t.status}`);Fe(t.data.orders||[])}function Fe(t=[]){i.ordersList.innerHTML="",t.forEach(e=>{const n=document.createElement("li"),a=document.createElement("div");a.textContent=`#${e.id} — R${e.restaurantId}`;const r=O(e.status,`status status-${e.status}`);r.style.marginLeft="8px",a.appendChild(r),n.appendChild(a);const s=document.createElement("div");s.className="muted",s.textContent=(e.items||[]).map(u=>`${u.name} x${u.qty}`).join(", "),n.appendChild(s);const d=O(e.paymentStatus||"Unpaid",`status pay-${e.paymentStatus||"Unpaid"}`);n.appendChild(d);const c=Se(e.status);if(c&&p()){const u=document.createElement("button");u.textContent=`Advance → ${c}`,u.addEventListener("click",async()=>{u.disabled=!0;try{await ke(e.id,c)}finally{u.disabled=!1}}),n.appendChild(u)}if(!e.paymentStatus||e.paymentStatus==="Unpaid"||e.paymentStatus==="Failed"){const u=document.createElement("button");u.textContent="Pay",u.addEventListener("click",()=>Re(e.id)),n.appendChild(u)}const l=document.createElement("button");l.textContent="Track",l.addEventListener("click",()=>Me(e.id)),n.appendChild(l),i.ordersList.appendChild(n)})}function Se(t){switch(t){case"Submitted":return"Accepted";case"Accepted":return"Preparing";case"Preparing":return"ReadyForPickup";default:return null}}async function ke(t,e){const n=await m(`/orders/${t}/status`,{method:"POST",body:{next:e}});n.ok?await H():n.status===409?o(`Invalid transition: ${n.data.error}`):n.status===401?o("Please login to perform this action."):n.status===403?o("Forbidden: staff or admin role required to advance orders."):o(`Failed to update: ${n.status}`)}let P=null,I=null,x=null;function Me(t){if(z(),!k)return o("API base not configured");i.trackingOrder.textContent=`#${t}`,i.trackingStatus.textContent="Connecting...",i.trackingCoords.textContent="",De();const e=`${k}/tracking/${t}/stream`;P=new EventSource(e),P.onmessage=n=>{try{const a=JSON.parse(n.data);a.type==="hello"?i.trackingStatus.textContent=`Status: ${a.status}`:a.type==="location"?(i.trackingCoords.textContent=`Lat ${a.lat.toFixed(6)}, Lng ${a.lng.toFixed(6)} @ ${new Date(a.ts).toLocaleTimeString()}`,qe(a.lat,a.lng)):a.type==="complete"&&(i.trackingStatus.textContent="Arrived (simulation complete)",z())}catch{}},P.onerror=()=>{i.trackingStatus.textContent="Connection error"}}function z(){P&&(P.close(),P=null),i.trackingStatus.textContent="Not tracking.",i.trackingOrder.textContent="—",i.trackingCoords.textContent="",He()}function De(){if(typeof L>"u")return;const t=document.getElementById("map");t&&(I||(I=L.map(t).setView([18.936,-99.223],14),L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{maxZoom:19,attribution:"&copy; OpenStreetMap contributors"}).addTo(I)))}function qe(t,e){if(!I)return;const n=[t,e];x?x.setLatLng(n):x=L.marker(n).addTo(I),I.setView(n,I.getZoom()||14)}function He(){x&&(I.removeLayer(x),x=null)}async function _(){if(g==="admin")try{const[t,e,n,a,r]=await Promise.all([m("/admin/metrics"),m("/admin/users"),m("/admin/restaurants"),m("/admin/orders"),be()]);t.ok&&We(t.data.metrics),e.ok&&Ve(e.data.users||[]),n.ok&&je(n.data.restaurants||[]),a.ok&&Je(a.data.orders||[])}catch(t){E(`admin load error: ${t.message}`)}}function We(t={}){const{usersTotal:e=0,restaurantsTotal:n=0,ordersTotal:a=0,revenueCents:r=0}=t,s=document.getElementById("admUsers"),d=document.getElementById("admRestaurants"),c=document.getElementById("admOrders"),l=document.getElementById("admRevenue");s&&(s.textContent=String(e)),d&&(d.textContent=String(n)),c&&(c.textContent=String(a)),l&&(l.textContent=C(Number(r)||0))}function Ve(t=[]){const e=document.getElementById("admUsersList");e&&(e.innerHTML="",t.forEach(n=>{const a=document.createElement("li"),r=document.createElement("span");r.textContent=`#${n.id} — ${n.email} (role: ${n.role}) `,a.appendChild(r);const s=document.createElement("select");["client","delivery","staff"].forEach(c=>{const l=document.createElement("option");l.value=c,l.textContent=c,n.role===c&&(l.selected=!0),s.appendChild(l)});const d=document.createElement("button");d.textContent="Set Role",d.addEventListener("click",async()=>{d.disabled=!0;try{const c=await m(`/admin/users/${n.id}/role`,{method:"PATCH",body:{role:s.value}});c.ok||o(`Failed to set role: ${c.status}`),await _()}finally{d.disabled=!1}}),a.appendChild(s),a.appendChild(d),e.appendChild(a)}))}function je(t=[]){const e=document.getElementById("admRestaurantsList");e&&(e.innerHTML="",t.forEach(n=>{const a=document.createElement("li");a.textContent=`#${n.id} — ${n.name}`,e.appendChild(a)}))}function Je(t=[]){const e=document.getElementById("admOrdersList");e&&(e.innerHTML="",t.forEach(n=>{const a=document.createElement("li"),r=O(n.status,`status status-${n.status}`),s=O(n.paymentStatus||"Unpaid",`status pay-${n.paymentStatus||"Unpaid"}`);a.textContent=`#${n.id} — R${n.restaurantId} `,a.appendChild(r),a.appendChild(s);const d=document.createElement("div");d.className="row";const c=document.createElement("select");(window.__adminPartners||[]).forEach($=>{const B=document.createElement("option");B.value=$.id,B.textContent=$.name?`#${$.id} — ${$.name}`:`#${$.id}`,c.appendChild(B)});const u=document.createElement("button");u.textContent="Assign",u.title="Assign this order to the selected delivery partner",u.addEventListener("click",async()=>{if(!c.value){o("Select a partner first");return}u.disabled=!0;try{await Ke(n.id,Number(c.value))&&o(`Assigned order #${n.id} to partner #${c.value}`)}finally{u.disabled=!1}}),d.appendChild(c),d.appendChild(u),a.appendChild(d),e.appendChild(a)}))}async function be(){try{const t=await m("/admin/delivery-partners");return t.ok?window.__adminPartners=t.data.partners||[]:window.__adminPartners=[],window.__adminPartners}catch{return window.__adminPartners=[],[]}}async function Ke(t,e){try{const n=await m("/admin/assignments",{method:"POST",body:{orderId:t,partnerId:e}});return n.ok?!0:(o(`Failed to assign: ${n.status}`),!1)}catch(n){return E(`assign error: ${n.message}`),!1}}let w=null,W=0;function ze(t){o(`[ADMIN] ${t}`)}function Z(){if(!document.getElementById("admUsers"))return;const e=document.getElementById("admBell");e&&(e.textContent=String(W))}function Pe(){try{G()}catch{}if(g!=="admin")return;const t=localStorage.getItem(N);if(!t)return;const e=`${k}/admin/events?token=${encodeURIComponent(t)}`;w=new EventSource(e),w.onmessage=n=>{try{const a=JSON.parse(n.data);W+=1,Z();const r=a.message||a.type;ze(r);const s=document.getElementById("admNotifications");if(s){const d=document.createElement("li");d.textContent=`${new Date(a.ts||Date.now()).toLocaleTimeString()} — ${a.type}: ${r}`,s.prepend(d)}}catch{}},w.addEventListener("ping",()=>{}),w.onerror=()=>{setTimeout(()=>{Pe()},3e3)}}function G(){if(w){try{w.close()}catch{}w=null}}let S=null,V=0,U=null,R=null;async function T(){try{const t=await m("/delivery/assignments");if(!t.ok)return o(`Failed to load assignments: ${t.status}`);const e=t.data.assignments||[],n=e.find(a=>a.status==="PickedUp")||e.find(a=>a.status==="Accepted")||null;R=n?Number(n.orderId):null,Ye(e)}catch(t){E(`delivery load error: ${t.message}`)}}function Ye(t=[]){const e=document.getElementById("delAssignments");e&&(e.innerHTML="",t.forEach(n=>{const a=document.createElement("li"),r=document.createElement("div");r.textContent=`Assignment #${n.id} — Order #${n.orderId} — ${n.status}`,a.appendChild(r);const s=document.createElement("div");s.className="row";const d=document.createElement("button");d.textContent="Accept",d.disabled=n.status!=="Assigned",d.addEventListener("click",async()=>{d.disabled=!0;try{await Ze(n.id),await T()}finally{d.disabled=!1}});const c=document.createElement("button");c.textContent="Picked Up",c.disabled=n.status!=="Accepted",c.addEventListener("click",async()=>{c.disabled=!0;try{await ee(n.id,"PickedUp"),await T()}finally{c.disabled=!1}});const l=document.createElement("button");l.textContent="Delivered",l.disabled=n.status!=="PickedUp",l.addEventListener("click",async()=>{l.disabled=!0;try{await ee(n.id,"Delivered"),await T()}finally{l.disabled=!1}}),s.appendChild(d),s.appendChild(c),s.appendChild(l),a.appendChild(s),e.appendChild(a)}))}async function Ze(t){var n;const e=await m(`/delivery/assignments/${encodeURIComponent(t)}/accept`,{method:"POST"});if(!e.ok)o(`Failed to accept: ${e.status}`);else try{R=Number((n=e.data.assignment)==null?void 0:n.orderId)||R}catch{}}async function ee(t,e){const n=await m(`/delivery/assignments/${encodeURIComponent(t)}/status`,{method:"POST",body:{status:e}});if(!n.ok)o(`Failed to set status: ${n.status}`);else try{const a=n.data.assignment;a&&(a.status==="PickedUp"&&(R=Number(a.orderId)),a.status==="Delivered"&&(R=null))}catch{}}function Q(){const t=document.getElementById("delBell");t&&(t.textContent=String(V))}function xe(){if(X(),g!=="delivery")return;const t=localStorage.getItem(N);if(!t)return;const e=`${k}/delivery/events?token=${encodeURIComponent(t)}`;S=new EventSource(e),S.onmessage=n=>{try{const a=JSON.parse(n.data);V+=1,Q();const r=a.message||a.type;o(`[DELIVERY] ${r}`);const s=document.getElementById("delNotifications");if(s){const d=document.createElement("li");d.textContent=`${new Date(a.ts||Date.now()).toLocaleTimeString()} — ${a.type}: ${r}`,s.prepend(d)}a.type==="assignment_created"&&T().catch(()=>{})}catch{}},S.addEventListener("ping",()=>{}),S.onerror=()=>{setTimeout(()=>xe(),3e3)}}function X(){if(S){try{S.close()}catch{}S=null}}function j(){U&&(clearInterval(U),U=null)}function Ge(){if(j(),g!=="delivery")return;const t=document.getElementById("delShareLocation");if(!(t!=null&&t.checked))return;const e=async n=>{try{const a=Number((n==null?void 0:n.latitude)??18.936),r=Number((n==null?void 0:n.longitude)??-99.223);await m("/delivery/location",{method:"POST",body:{lat:a,lng:r,orderId:R||null}})}catch{}};navigator.geolocation?navigator.geolocation.getCurrentPosition(n=>e(n.coords),()=>e(null),{enableHighAccuracy:!0,maximumAge:1e4}):e(null),U=setInterval(()=>{navigator.geolocation?navigator.geolocation.getCurrentPosition(n=>e(n.coords),()=>e(null),{enableHighAccuracy:!0,maximumAge:1e4}):e(null)},1e4)}var te;(te=i.loadRestaurantsBtn)==null||te.addEventListener("click",$e);var ne;(ne=i.clearCartBtn)==null||ne.addEventListener("click",()=>{y=[],b()});var ae;(ae=i.reviewOrderBtn)==null||ae.addEventListener("click",()=>o(we()));var re;(re=i.placeOrderBtn)==null||re.addEventListener("click",Le);var se;(se=i.refreshOrdersBtn)==null||se.addEventListener("click",H);var oe;(oe=i.stopTrackingBtn)==null||oe.addEventListener("click",z);var ie;(ie=i.chatSendBtn)==null||ie.addEventListener("click",Te);var de;(de=i.chatInput)==null||de.addEventListener("keydown",t=>{t.key==="Enter"&&Te()});var ce;(ce=document.getElementById("admRefreshBtn"))==null||ce.addEventListener("click",()=>{_().catch(()=>{})});var le;(le=document.getElementById("delRefreshBtn"))==null||le.addEventListener("click",()=>{T().catch(()=>{})});var ue;(ue=document.getElementById("delShareLocation"))==null||ue.addEventListener("change",()=>{document.getElementById("delShareLocation").checked?Ge():j()});var me;(me=i.navClient)==null||me.addEventListener("click",()=>{h(i.clientSection,!0),h(document.getElementById("deliverySection"),!1),h(document.getElementById("adminSection"),!1),D(i.clientSection)});var fe;(fe=i.navDelivery)==null||fe.addEventListener("click",()=>{h(i.clientSection,!1),h(document.getElementById("deliverySection"),!0),h(document.getElementById("adminSection"),!1),D(document.getElementById("deliverySection"))});var ye;(ye=i.navRestaurant)==null||ye.addEventListener("click",()=>{h(i.clientSection,!0),D(document.getElementById("rcOrdersList"))});var pe;(pe=i.navAdmin)==null||pe.addEventListener("click",()=>{h(i.clientSection,!1),h(document.getElementById("deliverySection"),!1),h(document.getElementById("adminSection"),!0),D(document.getElementById("adminSection"))});var ge;(ge=i.admCreatePartnerBtn)==null||ge.addEventListener("click",async()=>{var r,s,d,c,l,u;const t=(((r=i.admNewPartnerEmail)==null?void 0:r.value)||"").trim(),e=(((s=i.admNewPartnerName)==null?void 0:s.value)||"").trim(),n=(((d=i.admNewPartnerPhone)==null?void 0:d.value)||"").trim(),a=(((c=i.admNewPartnerVehicle)==null?void 0:c.value)||"").trim();if(!e){o("Name is required");return}try{const B=await m("/admin/delivery-partners",{method:"POST",body:t?{userEmail:t,name:e,phone:n,vehicleType:a}:{name:e,phone:n,vehicleType:a}});if(!B.ok){o(`Failed to create partner: ${B.status}`);return}o(`Created partner #${((l=B.data.partner)==null?void 0:l.id)||""} ${((u=B.data.partner)==null?void 0:u.name)||e}`),await be(),await _()}catch($){E(`partner create error: ${$.message}`)}});function Te(){var e;const t=(((e=i.chatInput)==null?void 0:e.value)||"").trim();t&&(i.chatInput.value="",o(`You: ${t}`),Qe(t))}async function Qe(t){const e=t.toLowerCase();if(e.startsWith("show restaurants")||e==="restaurants"||e==="show menus"||e==="show menu"){await $e(),o('Loaded restaurants. Tap one above or type "menu <name>"');return}if(e.startsWith("menu ")){const n=e.replace(/^menu\s+/,"").trim(),a=await m("/restaurants");if(a.ok){const r=(a.data.restaurants||[]).find(s=>s.name.toLowerCase().includes(n));r?(await Be(r),o(`Showing menu for ${r.name}`)):o(`Could not find restaurant matching "${n}"`)}else o("Failed to load restaurants");return}if(e.startsWith("add ")){const n=e.match(/^add\s+(\d+)\s+(.+)$/)||e.match(/^add\s+(.+)$/);let a=1,r="";if(n){n.length===3?(a=parseInt(n[1],10)||1,r=n[2]):r=n[1];const s=(Ce||[]).find(d=>d.name.toLowerCase().includes(r));if(!s)return o(`Item not found: ${r}`);for(let d=0;d<a;d++)Ie(s);o(`Added ${a} x ${s.name}`)}else o("Try: add 2 tacos");return}if(e.startsWith("remove ")||e.startsWith("delete ")){const n=e.match(/^(?:remove|delete)\s+(\d+)\s+(.+)$/)||e.match(/^(?:remove|delete)\s+(.+)$/);let a=1,r="";if(n){n.length===3?(a=parseInt(n[1],10)||1,r=n[2]):r=n[1];const s=y.findIndex(d=>d.name.toLowerCase().includes(r));if(s===-1)return o(`Item not in cart: ${r}`);y[s].qty-=a,y[s].qty<=0&&y.splice(s,1),b(),o(`Removed ${a} x ${r}`)}else o("Try: remove 1 tacos");return}if(e==="clear cart"){y=[],b(),o("Cart cleared");return}if(e==="summary"||e==="review"){o(we());return}if(e==="place order"||e==="order"){await Le();return}o("I didn't understand. Try: 'show restaurants', 'menu <name>', 'add 2 tacos', 'summary', 'place order'.")}const f={restaurant:document.getElementById("rcRestaurant"),loadBtn:document.getElementById("rcLoadOrdersBtn"),statusFilter:document.getElementById("rcStatusFilter"),autoRefresh:document.getElementById("rcAutoRefresh"),list:document.getElementById("rcOrdersList")};async function Xe(){try{const t=await m("/restaurants");if(!t.ok)return;f.restaurant.innerHTML="",(t.data.restaurants||[]).forEach(e=>{const n=document.createElement("option");n.value=e.id,n.textContent=`${e.name}`,f.restaurant.appendChild(n)}),q()}catch{}}async function J(){var e;const t=f.restaurant.value;if(!p())return o("Restaurant Console is available to staff or admin only. Please login as staff/admin.");if(!t)return o("Please select a restaurant to load orders.");try{f.loadBtn.disabled=!0;const n=await m(`/orders?restaurantId=${encodeURIComponent(t)}`);if(!n.ok)return o(`Failed to load orders for restaurant ${t}: ${n.status}`);const a=n.data.orders||[],r=((e=f.statusFilter)==null?void 0:e.value)||"all",s=r==="all"?a:a.filter(d=>d.status===r);et(s)}finally{f.loadBtn.disabled=!p()}}let F=null;function K(){F&&(clearInterval(F),F=null)}function Oe(){var t;K(),p()&&(t=f.autoRefresh)!=null&&t.checked&&(F=setInterval(()=>{J().catch(()=>{})},5e3))}function et(t=[]){f.list.innerHTML="",t.forEach(e=>{const n=document.createElement("li"),a=document.createElement("div");a.textContent=`#${e.id}`;const r=O(e.status,`status status-${e.status}`);r.style.marginLeft="8px";const s=O(e.paymentStatus||"Unpaid",`status pay-${e.paymentStatus||"Unpaid"}`);s.style.marginLeft="6px",a.appendChild(r),a.appendChild(s),n.appendChild(a);const d=document.createElement("div");d.className="muted",d.textContent=(e.items||[]).map(l=>`${l.name} x${l.qty}`).join(", "),n.appendChild(d);const c=Se(e.status);if(c){const l=document.createElement("button");l.textContent=`Advance → ${c}`,l.addEventListener("click",async()=>{l.disabled=!0;try{await ke(e.id,c),await J()}finally{l.disabled=!1}}),n.appendChild(l)}f.list.appendChild(n)})}var he;(he=f.loadBtn)==null||he.addEventListener("click",J);Xe();var Ee;(Ee=f.statusFilter)==null||Ee.addEventListener("change",()=>{p()&&J()});var ve;(ve=f.autoRefresh)==null||ve.addEventListener("change",()=>{f.autoRefresh.checked?Oe():K()});i.registerBtn.addEventListener("click",async()=>{var t;try{const e=i.email.value.trim(),n=i.password.value,a=((t=i.role)==null?void 0:t.value)||"client";if(!e||!/^[^@\s]+@[^@\s]+\.[^@\s]+$/.test(e))return o("Please enter a valid email.");if(!n||n.length<6)return o("Password must be at least 6 characters.");if(!["client","delivery","staff","admin"].includes(a))return o("Invalid role selected.");const r=await m("/auth/register",{method:"POST",body:{email:e,password:n,role:a}});if(r.ok){const s=r.data.email||e;try{localStorage.setItem(M,s)}catch{}o(`Registered ${s}`)}else o(`Register failed: ${r.status} ${r.data.error||""}`)}catch(e){E(`register error: ${e.message}`)}});i.loginBtn.addEventListener("click",async()=>{try{const t=i.email.value.trim(),e=i.password.value;if(!t)return o("Please enter your email.");if(!e)return o("Please enter your password.");const n=await m("/auth/login",{method:"POST",body:{email:t,password:e}});if(n.ok&&n.data.token){localStorage.setItem(N,n.data.token),o("Logged in");const a=await m("/me");if(a.ok){try{localStorage.setItem(M,a.data.user.email||"")}catch{}try{g=(a.data.user.role||"").toLowerCase(),localStorage.setItem(Y,g)}catch{}o(`Hello ${a.data.user.email} (role: ${a.data.user.role})`),q(),Oe(),g==="admin"&&await _()}}else o(`Login failed: ${n.status} ${n.data.error||""}`)}catch(t){E(`login error: ${t.message}`)}});i.logoutBtn.addEventListener("click",async()=>{try{const t=await m("/auth/logout",{method:"POST"});if(t.ok){localStorage.removeItem(N);try{localStorage.removeItem(Y),g="",q()}catch{}K(),G(),W=0,Z(),X(),j(),V=0,Q(),o("Logged out")}else o(`Logout failed: ${t.status} ${t.data.error||""}`)}catch(t){E(`logout error: ${t.message}`)}});try{if(!localStorage.getItem("onboarded"))o("Welcome to Marshanta!"),o("How to order: 1) Load restaurants, 2) Pick a restaurant and add items, 3) Place order, 4) Pay and track delivery."),o("Create an account or login to continue."),localStorage.setItem("onboarded","1");else{const e=localStorage.getItem(M);o(e?`Welcome back, ${e}!`:"Welcome back!")}}catch{o("Welcome to Marshanta!")}"serviceWorker"in navigator&&navigator.serviceWorker.register("/service-worker.js").then(()=>E("SW registered")).catch(t=>E(`SW error: ${t.message}`));
